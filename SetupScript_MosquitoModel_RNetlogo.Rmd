---
title: "MosquitoModel_setup"
author: "Dan Dawson"
date: "October 30, 2016"
output: html_document
---
This is a spatially explcit model of population dynamics of the mosquito species Culex tarsalis in the high plains of Texas. It is designed to work with the NetLogo model "Mosquito_Model_11_3_2016_Generalized_for_Distribution". The development and implementation of the model is fully described in the PhD disseratation by Daniel Dawson. The citation for this dissertation is: 

Dawson, Daniel. 2016. Exploring the effects of environmental characteristics and anthropogenic activities on mosquito populations: an experimental and spatially explicit model-based approach. PhD Dissertation. Texas Tech University. Lubbock, Texas. USA.


The basic premise of the model is that mosquitoes have two main life history phases, including an aquatic stage (egg-pupae) and a terrestrial adult phase. In the aquatic stage, the stressors that mosquito larvae experience are likely to be similar within the same aquatic environment. In contrast, since adults are highly dispersive, the stressors they experience are likely to be determined by where they move to in the world. This difference in exploited in the model by modeling both phases differently, but simultaneously. The aquatic phases of mosquitoes are modeled by leslie matrix models run in program R. Meanwhile, the adult phase modeled via an individual-based model in NetLogo. The Rpackage RNetLogo  interface between the two programs, and allows for interaction between them. In the model, individual adults move around a grid-based world in NetLogo, and deposit eggs into discrete wetlands in the landscape. When this occurs, their eggs are moved into matrix models in program R. As time elapses, the matrix models produce more adults, which then emerge from the wetlands back into the NetLogo world. Because vital rates of aquatic stages can be controlled on a per wetland basis, and adult vital rates and movement can be affected by habitat differences in the NetLogo world, this model structure explicitly allows for the influential of spatial heterogeneity on population dynamics  
In the current model, the aquatic phase uses survival and development rates that were derived from experimental data, and the IBM largely uses values from literature sources. In addition, the NetLogo world uses imagery of Lubbock County, Texas imported in an ascii format to determine patch values. For a full description of the model, see the doctoral thesis by Dawson (2016). Although the model was designed to simulate population dynamics of C. tarsalis mosquitoes, it could potentially be generalized to model any number of organisms with amphibious life histories.    

This model operates with two R scripts and one NetLogo model. The first script sets up the NetLogo model, generates the code blocks necessary to create Leslie matrices for each wetland simulated in the model, and determines the vital rates for mosquitoes in those wetlands. The second script loads the code generated by the first script into a function that also controls the model output. The function in the second script allows for multiple model runs. 

This rest of this script is script 1 of 2. You'll need to run the code in this script, and then copy and paste the output from the console into the appropriate spot in part 2, the "multiple-run" script.  


Note: this version of the model operates with a landcover map of Lubbock County, along with files for wetlands, wetland centers, and locations for mosquito traps. These files are listed below. These files need to be loaded in the NetLogo model itself. In addition, the directory needs to be set. See the NetLogo model with this R code to see how the directory is set and how the files are loaded into the model. 

Files needed for this model: 

"Lubbock_landcover_clipped_to_boundary_WGS1984_ascii.asc" 
 "HD_km2_120_ascii_3.asc"
"lubbock_nwis_08_07_20ag_prob_raster_ascii.asc"  
"lubbock_nwis_08_07_20ag_prob_raster_centers_ascii.asc"
 "VZL_trap_locations_ascii.asc" ; this file is optional, but provides locations for individuals to be "seeded" at the begining of the model for evaluation purposes
##################################################### 

This first part starts NetLogo and loads the model;you may need to adjust nl.path, depending upon where NetLogo is on your computer 
You also need to make sure that you have the current version of Java loaded. If you are using a 64-bit version of R, download and install the 64-bit version of Java from : https://www.java.com/en/download/manual.jsp
If you don't you will get an error message. 

Note, 

```{r}
rm(list=ls())
setwd<-"C:/Users/danidaws/Documents/Master Documents/Research/NetLogo/Current RNetLogo_Model work"

library(RNetLogo)
library(raster)  
nl.path<-"C:/Program Files (x86)/NetLogo 5.2.0"  #NetLogo file path on this computer
NLStart(nl.path, gui=F)  #Starting NetLogo from the filepate. Note, for multiple runs, turn off the the GUI for faster computation 
NLLoadModel("C:/Users/danidaws/Documents/Master Documents/Research/NetLogo/Current RNetLogo_Model work/ModelScenarios/MosquitoModel_5_9_2016_LCDisperse_NearestWLdisperse_fullrun_imagery_8_7_14_popdensity.nlogo")
NLLoadModel("C:/Users/danidaws/Documents/Master Documents/Research/NetLogo/Current RNetLogo_Model work/MosquitoModel_11_3_2016_Generalized_for_Distribution.nlogo")

NLQuit()

```


After loading the model, the first step is to adjust the size of the world (so that all wetlands fit) and to set up the coordinates of the wetlands.
```{r}
NLCommand("resize-world 0 456 0 382") # this lines up the NetLogo world with the LandSat Data. 
   
x.minmax<-NLReport("(list min-pxcor max-pxcor)") #gets x extent
y.minmax<-NLReport("(list min-pycor max-pycor)") #gets y extent

```


Next, the setup command is run, which loads the landscape into the NetLogo model. Please see the NetLogo model for a full explanation of setup procedures. 
```{r}

NLCommand("setup")
locations<-NLReport("[ (list xcor ycor idnumber) ] of wetlands") #Se
wllocmap<-data.frame(matrix(unlist(locations), nrow=length(locations), byrow=T))
colnames(wllocmap)<-c("xcor", "ycor", "IDnumber") 
wllocations<-wllocmap[order(wllocmap$IDnumber),] #a list of the coordinates of all the the wetlands
NumWet<-length(wllocations[,1]) # counts the number of wetlands

##Setting wetland centroid numbers and their xcor and ycor's##
xcor<- wllocations$xcor
ycor<-wllocations$ycor   
WLSimNo<-wllocations$IDnumber  #This pulls the ID number

```

If you want mosquitoes to be at certain locations at the beginning of model runs, you can do it by specifying specific locations in the Netlogo world. In this case, locations are specified at 5 locations. These need to be specified in the NetLogo model
```{r}
##VZL locations
VZLloc<-NLGetPatches(c("pxcor", "pycor","vzltrap"),patchset="patches", as.data.frame=T)
VZLloc<-VZLloc[VZLloc$vzltrap!="NaN",]
ReeceTrap<-VZLloc[VZLloc$vzltrap==1,]
QuakerTrap<-VZLloc[VZLloc$vzltrap==2,]
MBGCTrap<-VZLloc[VZLloc$vzltrap==3,]
KRFETrap<-VZLloc[VZLloc$vzltrap==4,]
EQTrap<-VZLloc[VZLloc$vzltrap==5,]
```


The below code chunks set the number of simulations to run and the parameter values for simulations. You can set the parameters to be constant per run, or vary them. As noted below, parameters to be used in the NetLogo model have be specified for each model run. Parameter values for the Leslie matrices in R do not. Make sure that this code is re-run if you want to change the total number of simulations or length of simulations. 
```{r}

##Note: parameters sent to Netlogo have to be replicated N times; once for each simulation; Matrix-model paramters don't. 

NoSimulations=20
simulation=60
Temp=25
TempRange=25

###Adults###
#Survival
Adultdailysurvvec<-rep(70, NoSimulations)

#GC length
GCsubLengthvec<-rep(-0.13847*Temp+8.44, NoSimulations)
GC1Lengthvec<-GCsubLengthvec + 2

#Dispersal
avg.daily.disvec<-rep(3.24, NoSimulations)
long.dis.maxvec<- rep(26.72, NoSimulations)  
longdis.disp.probvec<-rep(20.5, NoSimulations) 

#Fecundity
fecundityvec<-rep(96, NoSimulations)

VarMat1<-data.frame(Adultdailysurvvec,GC1Lengthvec, GCsubLengthvec, fecundityvec, avg.daily.disvec, long.dis.maxvec, longdis.disp.probvec)

    
###Aquatic Phase
EggDailySurvival=rep(0.74, 1)

TimeToHatch=2   
StartEggs=48      

###Larva and pupae #'s assume 25 deg conditions
LDevRatevec<-rep(12.305, 1)
LSurRatevec<-rep(0.85,1)

#Pupal 
PDevRatevec<-rep(2.039, 1)
PSurRatevec<-rep(0.85, 1)

####LC movement probabilities
WetlandProb<-0.2
ShrublandProb<-0.2
GrasslandProb<-0.234
DevelopedProb<-0.167
CroplandProb<-0.198
NAProb<-0.2

gravidWetlandProb<-0.002
gravidShrublandProb<-0.002
gravidGrasslandProb<-0.00234
gravidDevelopedProb<-0.00167
gravidCroplandProb<-0.00198
gravidNaProb<-0.002
gravidOvipositWetlandsProb<-0.999 

```


This chunk of code is used to assign treatment conditions to particular wetlands on particular days of the model run. It works by creating a vector that is multipled by the larval survival vector, thereby reducing the survival on the day of treatment. In the case below, the model is set up to run for 40 days using control conditions, cause 100% of larval mortality on day 41 to simulate a larvicide event, and then resume control conditons from day 42-60. The high risk wetlands below were identified by running the model with all wetlands first using conditions in August of 2014 (as identified via Landsat imagery) to ID high risk wetlands. 

Note, make sure that the total number of days in the treatment vector aligns with the total number of days per simulation. 
```{r}
########## Treatment Conditions

Pretreatmentdays<-42 # this is set to simulation because this currently assumes no treatment days. 
Treatday<-1
Posttreatmentdays<-simulation-(Pretreatmentdays+Treatday)
TreatmentSurvival<-0
NumberMosquitoes=1

##CONTROL
#Treatment Conditions: Control
for (i in 1:length(WLSimNo))
assign(paste("TreatmentMat", WLSimNo[i], sep=""), rep(LSurRatevec/LSurRatevec, simulation))
TreatmentMat1

####TREATMENT
#List of high risk wetlands; near roads, only 12 treated a day. 
HighRiskWL_SimNo1<-c(4 ,  5,   6,  14,  17,  55,  56,  61,  68,  89,  91, 100)
HighRiskWL_SimNo2<-c( 101, 107 ,109 ,110, 111, 112 ,113 ,114 ,115, 116 ,122 ,128)
HighRiskWL_SimNo3<-c(131, 132 ,136, 142, 144,150, 155, 175, 178, 183, 187, 190) 
  

#Treatment Conditions: Treatment High
for (i in 1:length(HighRiskWL_SimNo1))
assign(paste("TreatmentMat", HighRiskWL_SimNo1[i], sep=""), c(rep(LSurRatevec/LSurRatevec, Pretreatmentdays),rep(TreatmentSurvival/LSurRatevec, Treatday),rep(LSurRatevec/LSurRatevec, Posttreatmentdays )) )
TreatmentMat5 #This demonstrates that on day 41, larval survival is set to 0. 


for (i in 1:length(HighRiskWL_SimNo2))
assign(paste("TreatmentMat", HighRiskWL_SimNo2[i], sep=""), c(rep(LSurRatevec/LSurRatevec, Pretreatmentdays),rep(TreatmentSurvival/LSurRatevec, Treatday),rep(LSurRatevec/LSurRatevec, Posttreatmentdays )) )
TreatmentMat101 #This demonstrates that on day 42, larval survival is set to 0. 


for (i in 1:length(HighRiskWL_SimNo3))
assign(paste("TreatmentMat", HighRiskWL_SimNo3[i], sep=""), c(rep(LSurRatevec/LSurRatevec, Pretreatmentdays),rep(TreatmentSurvival/LSurRatevec, Treatday),rep(LSurRatevec/LSurRatevec, Posttreatmentdays )) )
TreatmentMat131 #This demonstrates that on day 43, larval survival is set to 0. 

#ControlMat
TreatmentMat1

```


The below chunk of code creates the code blocks to be run inside the model function in the second script to generate the vital rates and matrices for each wetland. Run the chunk, then copy and paste the output into the appropriate spot in the second script. Note, once this output is input into the script, you don't need to set it up again unless you add or subtract wetlands. 
####################################
```{r}

##########Wetland Model Codeblock Generator###################
##Run the below code and paste the output into the section below. This script produces code blocks for each 
##wetland

WLMatrices<-NULL
Start<-NULL
DataTemplate<-NULL
MatTemplate<-NULL
Cleanup<-NULL

###Setting up the Matrix models

#This section sets up the number of matrices required.
############
Start<-paste(" StartEgg<-StartEggs #This is to put 80 eggs in each playa lake. 
for (i in 1:NumWet)
assign(paste(\"Nproj\",i, sep=\"\"), matrix(c(StartEgg, rep(0, 4*simulation-1)), nrow = 4)) \n
NLDoCommand(1, \"go\") \n
for (i in 2:simulation) { \n
NLDoCommand(1, \"go\") \n
")
###################

#This section sets up DataTemplate, the vital rates via the models and prepares them for the transition matrix for each wetland
####################################
###Note: if not varying parameters between simulations, removed "[j]" reference after parameter vecs, e.g. LSurRatevec
for ( j in 1:length(xcor)) 
DataTemplate[j]<-paste(
"LarvaSurvival", WLSimNo[j],   "=LSurRatevec * TreatmentMat", WLSimNo[j],"\n
", "TimeToPupate", WLSimNo[j], "=LDevRatevec\n
", "PupaSurvival", WLSimNo[j], "=PSurRatevec\n
", "TimeToEmerge", WLSimNo[j], "=PDevRatevec\n        
","EggDailySurvival", WLSimNo[j], "=EggDailySurvival\n
", "larv.surv", WLSimNo[j], "=LarvaSurvival", WLSimNo[j],"^(1/TimeToPupate",WLSimNo[j],") \n
larv.dr", WLSimNo[j], "=1/TimeToPupate", WLSimNo[j], " \n
", "pup.surv", WLSimNo[j], "=PupaSurvival", WLSimNo[j],"^(1/TimeToEmerge",WLSimNo[j],") \n
pup.dr", WLSimNo[j], "=1/TimeToEmerge", WLSimNo[j], " \n
egg.surv=EggDailySurvival", WLSimNo[j],"^(1/TimeToHatch) \n
egg.dr=1/TimeToHatch \n
ES=egg.surv*(1-egg.dr) \n
ET=egg.surv*egg.dr \n
LS", WLSimNo[j], "=larv.surv", WLSimNo[j], "*(1-larv.dr", WLSimNo[j], ") \n
LT", WLSimNo[j], "=larv.surv", WLSimNo[j], "*larv.dr", WLSimNo[j], " \n
PS", WLSimNo[j], "=pup.surv", WLSimNo[j], "*(1-pup.dr", WLSimNo[j], ") \n
PT", WLSimNo[j], "=pup.surv", WLSimNo[j], "*pup.dr", WLSimNo[j], " \n
",sep="")


######################################

####this section produces a set of commands for each wetland at each daily iteration
#######################################
for ( j in 1:length(xcor))
MatTemplate[j]<-paste(
#Transition Matrix

"TM", WLSimNo[j], " = matrix(c(ES,	0,	                   0, 0,		
				      ET,	LS", WLSimNo[j],"[i],	 0, 0,			
				      0,	LT", WLSimNo[j],"[i],	 PS", WLSimNo[j],", 0,
		                  0,   0,                         PT", WLSimNo[j],", 1)
                        , nr = 4, byrow=T)", " \n


CountEggs", WLSimNo[j], "<-paste(\"count eggs with [playa = ", WLSimNo[j]," ]\")\n
Juv", WLSimNo[j], "<-NLReport(CountEggs", WLSimNo[j], ")\n
", "Nproj",WLSimNo[j],"[1, i-1] = Juv", WLSimNo[j], "+Nproj",WLSimNo[j],"[1,i-1]\n
", "Nproj",WLSimNo[j],"[1:4,i] = (TM", WLSimNo[j], "%*%Nproj",WLSimNo[j],"[1:4 ,i-1])\n
", "Adults", WLSimNo[j], "=floor(Nproj",WLSimNo[j],"[4, i])\n  
", "NoAdults", WLSimNo[j], "=paste(\"ask patches[if pxcor = ", xcor[j], " and pycor = ", ycor[j], " [ sprout-mosqs\"", ",", " Adults", WLSimNo[j], ",", "\" ]]\")\n
", "NLCommand(NoAdults", WLSimNo[j], ")\n
", "Nproj",WLSimNo[j],"[4,i]=0\n
", "Nproj",WLSimNo[j], "=ifelse(Nproj",WLSimNo[j],">0.1, Nproj",WLSimNo[j],", 0)\n

", sep="")

###################################

#Cleanup procedures; this section kills all eggs and reports the number of mosquitoes alive in the world
######################
Cleanup<-paste("NLCommand(\"ask eggs[die]\")")  #eggs at the end of each iteration to die because they've already been added into the matrix models 

####################### 

cat(DataTemplate, Start, MatTemplate, Cleanup)

```

After running the above code block, open the second script, and follow the instructions for copying and pasting the output into it.  

